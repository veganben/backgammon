<!doctype html>
<html>
<head>
    <title>Backgammon</title>
    <style>

        * {
            box-sizing: border-box;
        }

        body {
            background: url(img/baize.jpg) no-repeat 0 0;
            background-size: cover;
        }

        .spike6:nth-of-type(1) {
            margin-top: 10px;
        }
        .spike6:nth-of-type(2) {
            margin-top: 20px;
        }
        .spike6:nth-of-type(3) {
            margin-top: 30px;
        }
        .spike6:nth-of-type(4) {
            margin-top: 40px;
        }
        .spike6:nth-of-type(5) {
            margin-top: 50px;
        }
        .spike6:nth-of-type(6) {
            margin-top: 60px;
        }

        #board {
            border: 20px solid rgba(108,62,29,0.9);
            border-radius: 10px;
            border-width: 20px 24px;
            overflow: hidden;
            display: inline-block;
            background: url(img/bg.jpg) no-repeat 0 0;
            background-size: cover;
            background-origin: border-box;
            box-shadow: 0 0 15px;
            position: relative;
            background-color: #000;
            position: relative;
        }

        #rollingArea {
            display: inline-block;
            vertical-align: bottom;
        }

        #rollingArea.inactive #rollem, .die.inactive {
            opacity: 0.7;
            pointer-events: none;
        }

        #dice {
            width: 140px;
            margin: 20px;
        }

        #rollem {
            width: 140px;
            background: white;
            border: 1px solid black;
            padding: 20px;
            margin: 20px;
            font-family: Tahoma;
            font-size: 24px;
            border-top: 1px solid #f1f1f1;
            border-radius: 10px;
            position: relative;
            box-shadow: 0px 5px 0 #CCC, 0 6px 3px #444, 0 7px 5px #999;
            background-image: linear-gradient(top, #fefefe, #f1f1f1 80%);
            background: white;
        }

        #rollem:active {
            box-shadow: 0px;
        }

        .topboard, .bottomboard {
            position: relative;
            overflow: hidden;
        }

        .topboard {
            padding-bottom: 30px;
        }

        .outer {
            border-right: 36px solid #6F3E20;
            overflow: hidden;
            display: inline-block;
            float: left;
            clear: left;
        }
        .inner {
            border-left: 36px solid #6F3E20;
            overflow: hidden;
            display: inline-block;
            float: left;
            clear: right;
        }

        .bar {
            position: absolute;
            left: 439px;
            width: 60px;
            height: 300px;
            z-index: 10;
        }

        #redbar {
            top: 0px;
        }

        #whitebar {
            top: 329px;
        }

        .position {
            height: 0px;
            width: 0px;
            border-left: 36px solid transparent;
            border-right: 36px solid transparent;
            display: inline-block;
            float: left;
            display: relative:
        }

        .topboard .position {
            border-top: 300px solid  rgba(250,45,45,0.6);
        }

        .topboard .position:after {
        }

        .topboard .position:nth-child(even) {
            border-top: 300px solid rgba(250,250,250,0.8);
        }

        .bottomboard .position {
            border-bottom: 300px solid rgba(250,250,250,0.8);
        }

        .bottomboard .position:nth-child(even) {
            border-bottom: 300px solid rgba(250,45,45,0.6);
        }

/*** m√§nnle ***/

        .piece {
            height: 60px;
            width: 60px;
            border-radius: 30px;
            position: absolute;
            top: 0px;
            left: 0px;
            pointer-events: none;
             -webkit-transition: top .4s cubic-bezier(.36,.74,1,1.27),
                left .4s cubic-bezier(.36,.74,1,1.27);
            transition: top .4s cubic-bezier(.36,.74,1,1.27),
                left .4s cubic-bezier(.36,.74,1,1.27);
        }

        .red.piece {
            background: radial-gradient(ellipse at center, rgba(140,51,16,1) 0%,rgba(140,51,16,1) 6%,rgba(188,107,77,1) 32%,rgba(140,51,16,1) 49%,rgba(191,110,78,1) 55%,rgba(140,51,16,1) 62%,rgba(117,34,1,1) 63%,rgba(140,51,16,1) 88%);
        }

        .white.piece {
            background: white;
            border: 2px solid #666;
            border-radius: 30px;
            background: radial-gradient(ellipse at center, rgba(44,44,44,1) 0%, rgba(244,244,244,1) 26%, rgba(244,244,244,1) 45%, rgba(44,44,44,1) 67%, rgba(244,244,244,1) 78%);
        }

        .position1 {
            top: 0px;
        }
        .position2 {
            top: 60px;
        }
        .position3 {
            top: 120px;
        }
        .position4 {
            top: 180px;
        }
        .position5 {
            top: 240px;
        }

        .spikeBAR {
            left: 439px;
            top: 10px;
        }

        .lower.spikeBAR {
            top: 559px;
        }

        .lower.position1 {
            top: 569px;
        }
        .lower.position2 {
            top: 509px;
        }
        .lower.position3 {
            top: 449px;
        }
        .lower.position4 {
            top: 389px;
        }
        .lower.position5 {
            top: 329px;
        }

        .spikeBAR {
            left: 439px;
        }

        .spike1, .spike24 {
            left: 870px;
        }
        .spike2, .spike23 {
            left: 798px;
        }
        .spike3, .spike22 {
            left: 726px;
        }
        .spike4, .spike21 {
            left: 654px;
        }
        .spike5, .spike20 {
            left: 582px;
        }
        .spike6, .spike19 {
            left: 510px;
        }
        .spike7, .spike18 {
            left: 366px;
        }
        .spike8, .spike17 {
            left: 294px;
        }
        .spike9, .spike16 {
            left: 222px;
        }
        .spike10 , .spike15{
            left: 150px;
        }
        .spike11, .spike14 {
            left: 78px;
        }
        .spike12, .spike13 {
            left: 6px;
        }

/*** never say die ***/

        .die.one .dot {
            box-shadow: 0 .2em 0 #FFF
        }
        .die.two .dot {
            background: transparent;
            box-shadow: -2.3em -2.3em 0 #345,
                     2.3em  2.3em 0 #345,
                    -2.3em -2.3em 0 #FFF,
                     2.3em  2.4em 0 #FFF
        }
        .die.three .dot {
            box-shadow: -2.3em -2.3em 0 #345,
                     2.3em  2.3em 0 #345,
                    -2.3em -2.3em 0 #FFF,
                     2.3em  2.4em 0 #FFF,
                         0   .2em 0 #FFF
        }
        .die.four .dot {
            background: transparent;
                box-shadow: -2.3em -2.3em 0 #345,
                         2.3em  2.3em 0 #345,
                        -2.3em  2.3em 0 #345,
                         2.3em -2.3em 0 #345,
                        -2.3em -2.3em 0 #FFF,
                         2.3em  2.4em 0 #FFF,
                        -2.3em  2.4em 0 #FFF,
                         2.3em -2.3em 0 #FFF
        }
        .die.five .dot {
            box-shadow: -2.3em -2.3em 0 #345,
                     2.3em  2.3em 0 #345,
                    -2.3em  2.3em 0 #345,
                     2.3em -2.3em 0 #345,
                    -2.3em -2.2em 0 #FFF,
                     2.3em -2.2em 0 #FFF,
                     2.3em  2.4em 0 #FFF,
                    -2.3em  2.4em 0 #FFF,
                         0   .2em 0 #FFF
        }
        .die.six .dot {
            background: transparent;
            box-shadow: -2.3em -2.3em 0 #345,
                    -2.3em      0 0 #345,
                    -2.3em  2.3em 0 #345,
                     2.3em -2.3em 0 #345,
                     2.3em      0 0 #345,
                     2.3em  2.3em 0 #345,
                    -2.3em -2.1em 0 #FFF,
                    -2.3em   .2em 0 #FFF,
                    -2.3em  2.4em 0 #FFF,
                     2.3em  2.4em 0 #FFF,
                     2.3em   .2em 0 #FFF,
                     2.3em -2.1em 0 #FFF
        }
        .die {
            border-top: 1px solid #f1f1f1;
            width: 50px; height: 50px;
            border-radius: 10px;
            position: relative;
            margin: 10px;
            font-size: 6px;
            display: inline-block;
            box-shadow: 0px 5px 0 #CCC, 0 6px 3px #444, 0 10px 5px #999;
            background-image: linear-gradient(top, #fefefe, #f1f1f1 80%);
            background: white;
        }
        .dot {
            width: 20%;
            height: 20%;
            left: 50%;
            top: 50%;
            margin: -10%;
            background: #345;
            border-radius: 50%;
            display: block;
            position: absolute;
        }

    </style>
    <script>

        var $ = function(el){return document.getElementById(el)};

        var dom = {
            addClassName: function(el,nom) {
                if(el) {
                    var ecn = (!!el&&el.className)?el.className:"";
                    if(ecn.indexOf(nom)<0) {
                        el.className = ecn + " " + nom;
                    }
                }
            },
            /**
             * yes, it adds unnecessary whitespace
             */
            removeClassName: function(el,nom) {
                if(el) {
                    var cn = el.className || "";
                    var reg = new RegExp();
                    reg.compile("\\s\{1\,\}|\\b"+ nom + "\\b","gi");
                    var cnn = cn.replace(reg," ");
                    el.className = cnn;
                }
            }
        }

        var BackGammon = (function() {

            var maxMen = 5,
                initialPositions = {
                    red: [6,6,6,6,6,8,8,8,13,13,13,13,13,24,24],
                    white: [1,1,12,12,12,12,12,17,17,17,19,19,19,19,19]
                };

            var error = function(err) {
                alert(err);
            };

            var Piece = function(colour) {
            //         <div class="red piece spike7 position1" id="piece1"></div>
                var root = document.createElement("DIV");
                return {
                    root: root,
                    colour: colour,
                    currentSpike: undefined,
                    currentPosition: undefined
                }
            };

            var Spike = function(n) {
                var root = $("spike" + n),
                    thisSpike = n,
                    currentColour,
                    pieces = [],
                    addPiece,
                    getPieces;

                addPiece = function(piece) {
                    var classes = ["piece"],
                        sendToBar = false,
                        barPiece;
                    if(piece.isOnBar) {
                        currentColour = piece.colour;
                        piece.isOnBar = false;
                    }
                    if(pieces.length === maxMen) {
                        return false
                    } else {
                        if (currentColour) {
                            if (piece.colour !== currentColour) {
                                if(pieces.length === 1) {
                                    sendToBar = true;
                                } else {
                                    return false;
                                }
                            }
                        } else {
                            currentColour = piece.colour;
                        }
                        pieces.push(piece);
                        piece.currentSpike = thisSpike;
                        classes.push(piece.colour);
                        if (sendToBar) {
                            barPiece = pieces.shift();
                            barPiece.isOnBar = true;
                            currentColour = piece.colour;

                      //      classes.push(currentColour);
                      //      classes.push("bar");
                        }
                        piece.currentPosition = pieces.length;
                        classes.push("spike" + thisSpike);
                        if(thisSpike > 12){
                            classes.push("lower");
                        }
                        classes.push("position" + (sendToBar ? 0 : pieces.length));
                        piece.root.className = classes.join(" ");
                        return (barPiece || piece);
                    }
                };
                removePiece = function() {
                    if (currentColour === Controller.currentPlayer) {
                        if (pieces.length === 1){
                            currentColour = undefined;
                        }
                        return pieces.pop();
                    } else {
                        return false;
                    }
                };
                getTopPiece = function() {
                    return pieces[pieces.length-1];
                };
                root.addEventListener("click", function(e) {
                    if(pieces.length) {
                        Controller.spikeClicked(thisSpike);
                    } else {
                        return false;
                    }

                }, false);
                return {
                    addPiece: addPiece,
                    removePiece: removePiece,
                    id: thisSpike
                }
            };

            var Bar = function(colour) {
                var root = $(colour + "bar"),
                    thisBar = colour,
                    margin,
                    pieces = [],
                    isOccupied,
                    clickBar
                ;
                addPiece = function(piece) {
                    var margin = ((pieces.length) * 20);
                    pieces.push(piece);
                    if(thisBar === "red") {
                        piece.root.style.marginTop = margin + "px";
                    } else {
                        piece.root.style.marginTop = (-1 * margin) + "px";
                    }
                    piece.root.style.zIndex = pieces.length;
                };
                removePiece = function() {
                    var piece = pieces.pop();
                    piece.root.style.marginTop = "";
                    piece.root.style.marginBottom = "";
                    piece.root.style.zIndex = "inherit";
                    return piece;
                }

                isOccupied = function() {
                    return pieces.length;
                };
                clickBar = function() {
                    debugger;
                    if(isOccupied()) {
                        var piece = removePiece();
                        Controller.barClicked(piece);
                    }
                }
                root.addEventListener("click", clickBar, false);
                return {
                    root: root,
                    addPiece: addPiece,
                    isOccupied: isOccupied
                }
            };

            var Dice = function() {
                var root,
                    roll;
                root = document.createElement("DIV");
                root.className = "die inactive";
                root.innerHTML = '<span class="dot"></span>';
                roll = function() {
                    var rolled = Math.floor(Math.random()*6);
                    var newclassname = "die " + ["one","two","three","four","five","six"][rolled];
                    root.className = newclassname;
                    return rolled + 1;
                };
                return {
                    root: root,
                    roll: roll
                }
            };

            var createDice = function() {
                var dices,
                    flip,
                    rollDice,
                    root;
                root = document.createElement("div");
                root.id = "dice";
                dices = [Dice(), Dice()];
                root.appendChild(dices[0].root);
                root.appendChild(dices[1].root);
                flip = function() {
                    var dice1className = dices[0].root.className,
                        dice2className = dices[1].root.className;
                    if(dice1className.indexOf("inactive") == -1){
                        dices[0].root.className = dice2className;
                        dices[1].root.className = dice1className;
                    }
                    Controller.diceFlipped();
                };
                rollDice = function() {
                    var rolled = [dices[0].roll(), dices[1].roll()];
                    dom.removeClassName(dices[0].root, "inactive");
                    dom.removeClassName(dices[1].root, "inactive");
                    return rolled;
                };
                makeInactive = function(n) {
                    dom.addClassName(dices[n].root, "inactive");
                };
                return {
                    root: root,
                    flip: flip,
                    rollDice: rollDice,
                    makeInactive: makeInactive
                }
            };

            var Controller = (function() {
                var currentPlayer = "red",
                    diceFlipped,
                    addPieceToBar,
                    barClicked,
                    spikeClicked,
                    lastRoll = [],
                    isGameOver,
                    spikes = [],
                    bars = [],
                    i;

                diceFlipped = function() {
                    lastRoll.reverse();
                };
                addPieceToBar = function(piece) {
                    var newClasses = ["piece"];
                    bars[piece.colour].addPiece(piece);
                    newClasses.push(piece.colour);
                    if(piece.colour === "white") {
                        newClasses.push("lower");
                    }
                    newClasses.push("spikeBAR");
                    setTimeout(function(){piece.root.className = newClasses.join(" ");},600);
                };
                barClicked = function(piece) {
                    // piece is already free from the bar. Simply add to the new spike. (if possible);
                    var addResult,
                        spikeToPlace;
                    spikeToPlace = ((Controller.currentPlayer === "white") ? lastRoll[0] - 1 : 24 - lastRoll[0]);
                    addResult = spikes[spikeToPlace].addPiece(piece);
                    if(addResult) {
                        if(addResult.isOnBar) {
                            addPieceToBar(addResult);
                        }
                        if(lastRoll[1]) {
                            dice.makeInactive(0);
                        } else {
                            dice.makeInactive(1);
                        }
                        lastRoll.shift();
                    }
                    /*
                    else {
                        addPieceToBar(piece);
                    }*/
                };
                spikeClicked = function(n) {
                    var spike = spikes[n-1],
                        multiplier = (Controller.currentPlayer === "red" ? -1 : 1),
                        piece,
                        addResult;
                    if (lastRoll.length) {
                        if(bars[Controller.currentPlayer].isOccupied()) {
                            error("move off the bar first");
                            return false;
                        }
                        piece = spike.removePiece();
                        if (piece) {
                            addResult = spikes[(n - 1) + (multiplier *  lastRoll[0])].addPiece(piece);
                            if(addResult.isOnBar) {
                                addPieceToBar(addResult);
                            }
                            if(addResult) {
                                if(lastRoll[1]) {
                                    dice.makeInactive(0);
                                } else {
                                    dice.makeInactive(1);
                                    dom.removeClassName($("rollingArea"), "inactive");
                                    Controller.currentPlayer = (Controller.currentPlayer === "red" ? "white" : "red");
                                }
                                lastRoll.shift();
                            } else {
                                // put it back!
                                spike.addPiece(piece);
                                error("you can't move there");

                            }
                        } else {
                            error("not your piece");
                        }
                    } else {
                        error("roll the dice!");
                    }
                },

                createGame = function() {
                    var piece,
                        board = $("board"),
                        rollingArea = $("rollingArea"),
                        clickToRoll,
                        rollDice;
                     for (i = 0; i < 24; i++) {
                        var newSpike = Spike(i+1)
                        spikes.push(newSpike);
                    }
                    bars["red"] = Bar("red");
                    bars["white"] = Bar("white");
                    for(var colour in BackGammon.initialPositions) {
                        for (var i = 0; i <  BackGammon.initialPositions[colour].length; i++) {
                            var newPiece = Piece(colour);
                            piece = spikes[BackGammon.initialPositions[colour][i] - 1].addPiece(newPiece);
                            $("board").appendChild(piece.root);
                        }
                    }
                    var rollDice = function() {
                        var rollingArea = $("rollingArea")
                        if(lastRoll.length == 0) {
                            lastRoll = dice.rollDice();
                            dom.addClassName(rollingArea, "inactive");
                            $("rollem").blur();
                        } else {
                            error("still got moves to move");
                        }
                    }
                    dice = createDice();
                    clickToRoll = document.createElement("BUTTON");
                    clickToRoll.id = "rollem";
                    clickToRoll.innerHTML = "roll 'em";
                    rollingArea.appendChild(dice.root);
                    rollingArea.appendChild(clickToRoll);
                    dice.root.addEventListener("click", dice.flip, false);
                    clickToRoll.addEventListener("click", rollDice, false)
                    //  dice.rollDice = [];
                    // make something to click to roll the dice
                }

                return {
                    currentPlayer: currentPlayer,
                    barClicked: barClicked,
                    spikeClicked: spikeClicked,
                    diceFlipped: diceFlipped,
                    createGame: createGame
                }

            })();

            var init = function() {
                Controller.createGame();
            };

            return {
                init: init,
                initialPositions: initialPositions
            }

        }());

    window.addEventListener("load", BackGammon.init, false);

    </script>
</head>
<body>
    <div id="board">
        <div id="redouter" class="topboard outer">
            <div id="spike12" class="position"></div>
            <div id="spike11" class="position"></div>
            <div id="spike10" class="position"></div>
            <div id="spike9" class="position"></div>
            <div id="spike8" class="position"></div>
            <div id="spike7" class="position"></div>
        </div>
        <div id="redinner" class="topboard inner">
            <div id="spike6" class="position"></div>
            <div id="spike5" class="position"></div>
            <div id="spike4" class="position"></div>
            <div id="spike3" class="position"></div>
            <div id="spike2" class="position"></div>
            <div id="spike1" class="position"></div>
        </div>
        <div id="redbar" class="bar"></div>
        <div id="whitebar" class="bar"></div>
        <div id="whiteouter" class="bottomboard outer">
            <div id="spike13" class="position"></div>
            <div id="spike14" class="position"></div>
            <div id="spike15" class="position"></div>
            <div id="spike16" class="position"></div>
            <div id="spike17" class="position"></div>
            <div id="spike18" class="position"></div>
        </div>
        <div id="whiteinner" class="bottomboard inner">
            <div id="spike19" class="position"></div>
            <div id="spike20" class="position"></div>
            <div id="spike21" class="position"></div>
            <div id="spike22" class="position"></div>
            <div id="spike23" class="position"></div>
            <div id="spike24" class="position"></div>
        </div>
    </div>
    <div id="rollingArea"></div>
</body>
</html>
